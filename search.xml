<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>2023/12/01-刷算法记录</title>
    <url>/post/2023/12/01-%E5%88%B7%E7%AE%97%E6%B3%95%E8%AE%B0%E5%BD%95.html</url>
    <content><![CDATA[<p><a href="https://leetcode.cn/problems/convert-bst-to-greater-tree/">538.把二叉搜索树转换为累加树</a><br> <a href="https://leetcode.cn/problems/minimum-distance-between-bst-nodes/">783.二叉搜索树节点最小距离</a></p>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>递归</tag>
      </tags>
  </entry>
  <entry>
    <title>Elastic Search之Script熔断异常</title>
    <url>/post/b146d7e0-901f-11ee-a21b-4d1d02b3c802.html</url>
    <content><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>客服突然反馈，检索某个sku需要多次才能出现结果。</p>
<h3 id="排查思路-解决方案"><a href="#排查思路-解决方案" class="headerlink" title="排查思路&#x2F;解决方案"></a>排查思路&#x2F;解决方案</h3><p>1、这个sku处于下架状态，下架状态的sku是不允许检索的。结果查看数据处于上架状态，所以这个思路是错误的（×）</p>
<p>2、增加日志，打印ES查询语句，并添加查询ES错误栈信息打印。日志打印后，发现ES查询正常，但是抛出了异常：Elasticsearch exception [type&#x3D;search_phase_execution_exception, reason&#x3D;all shards failed]，看到这个错误后发现是ES分片出现异常可能是ES节点状态处于不健康状态，因为最近是黑五网一，对ES的复杂请求要比之间的流量要大至少一倍，所以怀疑是对ES的访问负载过高导致ES节点处于不健康状态。结果登录控制台查看发现是节点处于绿色状态（健康状态），第一时间懵了，但是看到ES对Http请求中有部分出现50X的访问异常，立马查看日志，日志如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><span class="hljs-number">2023</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span>T02<span class="hljs-punctuation">:</span><span class="hljs-number">25</span><span class="hljs-punctuation">:</span><span class="hljs-number">13</span><span class="hljs-punctuation">,</span><span class="hljs-number">005</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>WARN <span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>r.suppressed             <span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span>ff1a084489778d82a0ccf314aef5df98<span class="hljs-punctuation">]</span> path<span class="hljs-punctuation">:</span> __PATH__ params<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>typed_keys=<span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> max_concurrent_shard_requests=<span class="hljs-number">5</span><span class="hljs-punctuation">,</span> ignore_unavailable=<span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span> expand_wildcards=open<span class="hljs-punctuation">,</span> allow_no_indices=<span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> ignore_throttled=<span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> index=index_product_3<span class="hljs-punctuation">,</span> search_type=query_then_fetch<span class="hljs-punctuation">,</span> batched_reduce_size=<span class="hljs-number">512</span><span class="hljs-punctuation">,</span> ccs_minimize_roundtrips=<span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">&#125;</span><br><br>Failed to execute phase <span class="hljs-punctuation">[</span>query<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> all shards failed; shardFailures <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">[</span><span class="hljs-number">4</span>TJsxlKXT8io4YxAo1t3aw<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>index_product_3<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">:</span> RemoteTransportException<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">1</span>f058616eb2ec8a3e231c3eee031132b<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>__IP__<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>__PATH__<span class="hljs-punctuation">[</span>__PATH__<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>; nested<span class="hljs-punctuation">:</span> GeneralScriptException<span class="hljs-punctuation">[</span>Failed to compile inline script <span class="hljs-punctuation">[</span> int sortIndex = <span class="hljs-number">0</span>;if (params._source.productCategoryVOList != <span class="hljs-literal"><span class="hljs-keyword">null</span></span> &amp;&amp; params._source.productCategoryVOList.size () &gt; <span class="hljs-number">0</span>) <span class="hljs-punctuation">&#123;</span>for(int i = <span class="hljs-number">0</span>;i&lt;params._source.productCategoryVOList.size();i++)<span class="hljs-punctuation">&#123;</span>if(params._source.productCategoryVOList.get(i).categoryId.equals(<span class="hljs-number">291</span>)  &amp;&amp;  params._source.productCategoryVOList.get(i).level &gt; sortIndex ) <span class="hljs-punctuation">&#123;</span> sortIndex =  params._source.productCategoryVOList.get(i).level;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span> return sortIndex;<span class="hljs-punctuation">]</span> using lang <span class="hljs-punctuation">[</span>painless<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>; nested<span class="hljs-punctuation">:</span> CircuitBreakingException<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span>script<span class="hljs-punctuation">]</span> Too many dynamic script compilations within<span class="hljs-punctuation">,</span> max<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>__PATH__<span class="hljs-punctuation">]</span>; please use indexed<span class="hljs-punctuation">,</span> or scripts with parameters instead; this limit can be changed by the <span class="hljs-punctuation">[</span>script.context.number_sort.max_compilations_rate<span class="hljs-punctuation">]</span> setting<span class="hljs-punctuation">]</span>; <span class="hljs-punctuation">&#125;</span><br><br>	at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">568</span>)<br><br>	at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">324</span>)<br><br>	at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">603</span>)<br><br>	at org.elasticsearch.action.search.AbstractSearchAsyncAction.onShardFailure(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">400</span>)<br><br>	at org.elasticsearch.action.search.AbstractSearchAsyncAction.access$<span class="hljs-number">100</span>(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">70</span>)<br><br>	at org.elasticsearch.action.search.AbstractSearchAsyncAction$<span class="hljs-number">1.</span>onFailure(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">258</span>)<br><br>	at org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java<span class="hljs-punctuation">:</span><span class="hljs-number">73</span>)<br><br>	at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">59</span>)<br><br>	at org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java<span class="hljs-punctuation">:</span><span class="hljs-number">408</span>)<br><br>	at org.elasticsearch.transport.TransportService$<span class="hljs-number">6.</span>handleException(TransportService.java<span class="hljs-punctuation">:</span><span class="hljs-number">640</span>)<br><br>	at org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java<span class="hljs-punctuation">:</span><span class="hljs-number">1181</span>)<br><br>	at org.elasticsearch.transport.InboundHandler.lambda$handleException$<span class="hljs-number">3</span>(InboundHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">277</span>)<br><br>	at org.elasticsearch.common.util.concurrent.EsExecutors$DirectExecutorService.execute(EsExecutors.java<span class="hljs-punctuation">:</span><span class="hljs-number">253</span>)<br><br>	at org.elasticsearch.transport.InboundHandler.handleException(InboundHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">275</span>)<br><br>	at org.elasticsearch.transport.InboundHandler.handlerResponseError(InboundHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">267</span>)<br><br>	at org.elasticsearch.transport.InboundHandler.messageReceived(InboundHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">131</span>)<br><br>	at org.elasticsearch.transport.InboundHandler.inboundMessage(InboundHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">89</span>)<br><br>	at org.elasticsearch.transport.TcpTransport.inboundMessage(TcpTransport.java<span class="hljs-punctuation">:</span><span class="hljs-number">700</span>)<br><br>	at org.elasticsearch.transport.InboundPipeline.forwardFragments(InboundPipeline.java<span class="hljs-punctuation">:</span><span class="hljs-number">142</span>)<br><br>	at org.elasticsearch.transport.InboundPipeline.doHandleBytes(InboundPipeline.java<span class="hljs-punctuation">:</span><span class="hljs-number">117</span>)<br><br>	at org.elasticsearch.transport.InboundPipeline.handleBytes(InboundPipeline.java<span class="hljs-punctuation">:</span><span class="hljs-number">82</span>)<br><br>	at org.elasticsearch.transport.netty4.Netty4MessageChannelHandler.channelRead(Netty4MessageChannelHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">74</span>)<br><br>	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">379</span>)<br><br>	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">365</span>)<br><br>	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">357</span>)<br><br>	at io.netty.handler.logging.LoggingHandler.channelRead(LoggingHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">271</span>)<br><br>	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">379</span>)<br><br>	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">365</span>)<br><br>	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">357</span>)<br><br>	at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java<span class="hljs-punctuation">:</span><span class="hljs-number">1410</span>)<br><br>	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">379</span>)<br><br>	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">365</span>)<br><br>	at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java<span class="hljs-punctuation">:</span><span class="hljs-number">919</span>)<br><br>	at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java<span class="hljs-punctuation">:</span><span class="hljs-number">163</span>)<br><br>	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java<span class="hljs-punctuation">:</span><span class="hljs-number">714</span>)<br><br>	at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java<span class="hljs-punctuation">:</span><span class="hljs-number">615</span>)<br><br>	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java<span class="hljs-punctuation">:</span><span class="hljs-number">578</span>)<br><br>	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java<span class="hljs-punctuation">:</span><span class="hljs-number">493</span>)<br><br>	at io.netty.util.concurrent.SingleThreadEventExecutor$<span class="hljs-number">4.</span>run(SingleThreadEventExecutor.java<span class="hljs-punctuation">:</span><span class="hljs-number">989</span>)<br><br>	at io.netty.util.internal.ThreadExecutorMap$<span class="hljs-number">2.</span>run(ThreadExecutorMap.java<span class="hljs-punctuation">:</span><span class="hljs-number">74</span>)<br><br>	at __PATH__(Thread.java<span class="hljs-punctuation">:</span><span class="hljs-number">829</span>)<br><br>Caused by<span class="hljs-punctuation">:</span> CircuitBreakingException<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span>script<span class="hljs-punctuation">]</span> Too many dynamic script compilations within<span class="hljs-punctuation">,</span> max<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>__PATH__<span class="hljs-punctuation">]</span>; please use indexed<span class="hljs-punctuation">,</span> or scripts with parameters instead; this limit can be changed by the <span class="hljs-punctuation">[</span>script.context.number_sort.max_compilations_rate<span class="hljs-punctuation">]</span> setting<span class="hljs-punctuation">]</span><br><br>	at org.elasticsearch.script.ScriptCache.checkCompilationLimit(ScriptCache.java<span class="hljs-punctuation">:</span><span class="hljs-number">179</span>)<br><br>	at org.elasticsearch.script.ScriptCache.lambda$compile$<span class="hljs-number">0</span>(ScriptCache.java<span class="hljs-punctuation">:</span><span class="hljs-number">109</span>)<br><br>	at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java<span class="hljs-punctuation">:</span><span class="hljs-number">433</span>)<br><br>	at org.elasticsearch.script.ScriptCache.compile(ScriptCache.java<span class="hljs-punctuation">:</span><span class="hljs-number">99</span>)<br><br>	at org.elasticsearch.script.ScriptService.compile(ScriptService.java<span class="hljs-punctuation">:</span><span class="hljs-number">384</span>)<br><br>	at org.elasticsearch.index.query.QueryShardContext.compile(QueryShardContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">401</span>)<br><br>	at org.elasticsearch.search.sort.ScriptSortBuilder.fieldComparatorSource(ScriptSortBuilder.java<span class="hljs-punctuation">:</span><span class="hljs-number">380</span>)<br><br>	at org.elasticsearch.search.sort.ScriptSortBuilder.build(ScriptSortBuilder.java<span class="hljs-punctuation">:</span><span class="hljs-number">312</span>)<br><br>	at org.elasticsearch.search.sort.SortBuilder.buildSort(SortBuilder.java<span class="hljs-punctuation">:</span><span class="hljs-number">159</span>)<br><br>	at org.elasticsearch.search.SearchService.parseSource(SearchService.java<span class="hljs-punctuation">:</span><span class="hljs-number">906</span>)<br><br>	at org.elasticsearch.search.SearchService.createContext(SearchService.java<span class="hljs-punctuation">:</span><span class="hljs-number">726</span>)<br><br>	at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java<span class="hljs-punctuation">:</span><span class="hljs-number">428</span>)<br><br>	at org.elasticsearch.search.SearchService.access$<span class="hljs-number">500</span>(SearchService.java<span class="hljs-punctuation">:</span><span class="hljs-number">141</span>)<br><br>	at org.elasticsearch.search.SearchService$<span class="hljs-number">2.</span>lambda$onResponse$<span class="hljs-number">0</span>(SearchService.java<span class="hljs-punctuation">:</span><span class="hljs-number">401</span>)<br><br>	at org.elasticsearch.action.ActionRunnable.lambda$supply$<span class="hljs-number">0</span>(ActionRunnable.java<span class="hljs-punctuation">:</span><span class="hljs-number">58</span>)<br><br>	at org.elasticsearch.action.ActionRunnable$<span class="hljs-number">2.</span>doRun(ActionRunnable.java<span class="hljs-punctuation">:</span><span class="hljs-number">73</span>)<br><br>	at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java<span class="hljs-punctuation">:</span><span class="hljs-number">37</span>)<br><br>	at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java<span class="hljs-punctuation">:</span><span class="hljs-number">44</span>)<br><br>	at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">752</span>)<br><br>	at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java<span class="hljs-punctuation">:</span><span class="hljs-number">37</span>)<br><br>	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java<span class="hljs-punctuation">:</span><span class="hljs-number">1128</span>)<br><br>	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java<span class="hljs-punctuation">:</span><span class="hljs-number">628</span>)<br><br>	at java.lang.Thread.run(Thread.java<span class="hljs-punctuation">:</span><span class="hljs-number">829</span>)<br><br><span class="hljs-punctuation">[</span><span class="hljs-number">2023</span><span class="hljs-number">-11</span><span class="hljs-number">-21</span>T02<span class="hljs-punctuation">:</span><span class="hljs-number">25</span><span class="hljs-punctuation">:</span><span class="hljs-number">13</span><span class="hljs-punctuation">,</span><span class="hljs-number">005</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>WARN <span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>r.suppressed <span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span>ff1a084489778d82a0ccf314aef5df98<span class="hljs-punctuation">]</span> path<span class="hljs-punctuation">:</span> __PATH__ params<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>typed_keys=<span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> max_concurrent_shard_requests=<span class="hljs-number">5</span><span class="hljs-punctuation">,</span> ignore_unavailable=<span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span> expand_wildcards=open<span class="hljs-punctuation">,</span> allow_no_indices=<span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> ignore_throttled=<span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> index=index_product_3<span class="hljs-punctuation">,</span> search_type=query_then_fetch<span class="hljs-punctuation">,</span> batched_reduce_size=<span class="hljs-number">512</span><span class="hljs-punctuation">,</span> ccs_minimize_roundtrips=<span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">&#125;</span> Failed to execute phase <span class="hljs-punctuation">[</span>query<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> all shards failed; shardFailures <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">[</span><span class="hljs-number">4</span>TJsxlKXT8io4YxAo1t3aw<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>index_product_3<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">:</span> RemoteTransportException<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">1</span>f058616eb2ec8a3e231c3eee031132b<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>__IP__<span class="hljs-punctuation">]</span><span class="hljs-punctuation">[</span>__PATH__<span class="hljs-punctuation">[</span>__PATH__<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>; nested<span class="hljs-punctuation">:</span> GeneralScriptException<span class="hljs-punctuation">[</span>Failed to compile inline script <span class="hljs-punctuation">[</span> int sortIndex = <span class="hljs-number">0</span>;if (params._source.productCategoryVOList != <span class="hljs-literal"><span class="hljs-keyword">null</span></span> &amp;&amp; params._source.productCategoryVOList.size () &gt; <span class="hljs-number">0</span>) <span class="hljs-punctuation">&#123;</span>for(int i = <span class="hljs-number">0</span>;i&lt;params._source.productCategoryVOList.size();i++)<span class="hljs-punctuation">&#123;</span>if(params._source.productCategoryVOList.get(i).categoryId.equals(<span class="hljs-number">291</span>) &amp;&amp; params._source.productCategoryVOList.get(i).level &gt; sortIndex ) <span class="hljs-punctuation">&#123;</span> sortIndex = params._source.productCategoryVOList.get(i).level;<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span> return sortIndex;<span class="hljs-punctuation">]</span> using lang <span class="hljs-punctuation">[</span>painless<span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>; nested<span class="hljs-punctuation">:</span> CircuitBreakingException<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span>script<span class="hljs-punctuation">]</span> Too many dynamic script compilations within<span class="hljs-punctuation">,</span> max<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>__PATH__<span class="hljs-punctuation">]</span>; please use indexed<span class="hljs-punctuation">,</span> or scripts with parameters instead; this limit can be changed by the <span class="hljs-punctuation">[</span>script.context.number_sort.max_compilations_rate<span class="hljs-punctuation">]</span> setting<span class="hljs-punctuation">]</span>; <span class="hljs-punctuation">&#125;</span> at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">568</span>) at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">324</span>) at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">603</span>) at org.elasticsearch.action.search.AbstractSearchAsyncAction.onShardFailure(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">400</span>) at org.elasticsearch.action.search.AbstractSearchAsyncAction.access$<span class="hljs-number">100</span>(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">70</span>) at org.elasticsearch.action.search.AbstractSearchAsyncAction$<span class="hljs-number">1.</span>onFailure(AbstractSearchAsyncAction.java<span class="hljs-punctuation">:</span><span class="hljs-number">258</span>) at org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java<span class="hljs-punctuation">:</span><span class="hljs-number">73</span>) at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">59</span>) at org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java<span class="hljs-punctuation">:</span><span class="hljs-number">408</span>) at org.elasticsearch.transport.TransportService$<span class="hljs-number">6.</span>handleException(TransportService.java<span class="hljs-punctuation">:</span><span class="hljs-number">640</span>) at org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java<span class="hljs-punctuation">:</span><span class="hljs-number">1181</span>) at org.elasticsearch.transport.InboundHandler.lambda$handleException$<span class="hljs-number">3</span>(InboundHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">277</span>) at org.elasticsearch.common.util.concurrent.EsExecutors$DirectExecutorService.execute(EsExecutors.java<span class="hljs-punctuation">:</span><span class="hljs-number">253</span>) at org.elasticsearch.transport.InboundHandler.handleException(InboundHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">275</span>) at org.elasticsearch.transport.InboundHandler.handlerResponseError(InboundHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">267</span>) at org.elasticsearch.transport.InboundHandler.messageReceived(InboundHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">131</span>) at org.elasticsearch.transport.InboundHandler.inboundMessage(InboundHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">89</span>) at org.elasticsearch.transport.TcpTransport.inboundMessage(TcpTransport.java<span class="hljs-punctuation">:</span><span class="hljs-number">700</span>) at org.elasticsearch.transport.InboundPipeline.forwardFragments(InboundPipeline.java<span class="hljs-punctuation">:</span><span class="hljs-number">142</span>) at org.elasticsearch.transport.InboundPipeline.doHandleBytes(InboundPipeline.java<span class="hljs-punctuation">:</span><span class="hljs-number">117</span>) at org.elasticsearch.transport.InboundPipeline.handleBytes(InboundPipeline.java<span class="hljs-punctuation">:</span><span class="hljs-number">82</span>) at org.elasticsearch.transport.netty4.Netty4MessageChannelHandler.channelRead(Netty4MessageChannelHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">74</span>) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">379</span>) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">365</span>) at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">357</span>) at io.netty.handler.logging.LoggingHandler.channelRead(LoggingHandler.java<span class="hljs-punctuation">:</span><span class="hljs-number">271</span>) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">379</span>) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">365</span>) at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">357</span>) at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java<span class="hljs-punctuation">:</span><span class="hljs-number">1410</span>) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">379</span>) at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">365</span>) at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java<span class="hljs-punctuation">:</span><span class="hljs-number">919</span>) at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java<span class="hljs-punctuation">:</span><span class="hljs-number">163</span>) at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java<span class="hljs-punctuation">:</span><span class="hljs-number">714</span>) at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java<span class="hljs-punctuation">:</span><span class="hljs-number">615</span>) at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java<span class="hljs-punctuation">:</span><span class="hljs-number">578</span>) at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java<span class="hljs-punctuation">:</span><span class="hljs-number">493</span>) at io.netty.util.concurrent.SingleThreadEventExecutor$<span class="hljs-number">4.</span>run(SingleThreadEventExecutor.java<span class="hljs-punctuation">:</span><span class="hljs-number">989</span>) at io.netty.util.internal.ThreadExecutorMap$<span class="hljs-number">2.</span>run(ThreadExecutorMap.java<span class="hljs-punctuation">:</span><span class="hljs-number">74</span>) at __PATH__(Thread.java<span class="hljs-punctuation">:</span><span class="hljs-number">829</span>) Caused by<span class="hljs-punctuation">:</span> CircuitBreakingException<span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span>script<span class="hljs-punctuation">]</span> Too many dynamic script compilations within<span class="hljs-punctuation">,</span> max<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>__PATH__<span class="hljs-punctuation">]</span>; please use indexed<span class="hljs-punctuation">,</span> or scripts with parameters instead; this limit can be changed by the <span class="hljs-punctuation">[</span>script.context.number_sort.max_compilations_rate<span class="hljs-punctuation">]</span> setting<span class="hljs-punctuation">]</span> at org.elasticsearch.script.ScriptCache.checkCompilationLimit(ScriptCache.java<span class="hljs-punctuation">:</span><span class="hljs-number">179</span>) at org.elasticsearch.script.ScriptCache.lambda$compile$<span class="hljs-number">0</span>(ScriptCache.java<span class="hljs-punctuation">:</span><span class="hljs-number">109</span>) at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java<span class="hljs-punctuation">:</span><span class="hljs-number">433</span>) at org.elasticsearch.script.ScriptCache.compile(ScriptCache.java<span class="hljs-punctuation">:</span><span class="hljs-number">99</span>) at org.elasticsearch.script.ScriptService.compile(ScriptService.java<span class="hljs-punctuation">:</span><span class="hljs-number">384</span>) at org.elasticsearch.index.query.QueryShardContext.compile(QueryShardContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">401</span>) at org.elasticsearch.search.sort.ScriptSortBuilder.fieldComparatorSource(ScriptSortBuilder.java<span class="hljs-punctuation">:</span><span class="hljs-number">380</span>) at org.elasticsearch.search.sort.ScriptSortBuilder.build(ScriptSortBuilder.java<span class="hljs-punctuation">:</span><span class="hljs-number">312</span>) at org.elasticsearch.search.sort.SortBuilder.buildSort(SortBuilder.java<span class="hljs-punctuation">:</span><span class="hljs-number">159</span>) at org.elasticsearch.search.SearchService.parseSource(SearchService.java<span class="hljs-punctuation">:</span><span class="hljs-number">906</span>) at org.elasticsearch.search.SearchService.createContext(SearchService.java<span class="hljs-punctuation">:</span><span class="hljs-number">726</span>) at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java<span class="hljs-punctuation">:</span><span class="hljs-number">428</span>) at org.elasticsearch.search.SearchService.access$<span class="hljs-number">500</span>(SearchService.java<span class="hljs-punctuation">:</span><span class="hljs-number">141</span>) at org.elasticsearch.search.SearchService$<span class="hljs-number">2.</span>lambda$onResponse$<span class="hljs-number">0</span>(SearchService.java<span class="hljs-punctuation">:</span><span class="hljs-number">401</span>) at org.elasticsearch.action.ActionRunnable.lambda$supply$<span class="hljs-number">0</span>(ActionRunnable.java<span class="hljs-punctuation">:</span><span class="hljs-number">58</span>) at org.elasticsearch.action.ActionRunnable$<span class="hljs-number">2.</span>doRun(ActionRunnable.java<span class="hljs-punctuation">:</span><span class="hljs-number">73</span>) at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java<span class="hljs-punctuation">:</span><span class="hljs-number">37</span>) at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java<span class="hljs-punctuation">:</span><span class="hljs-number">44</span>) at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java<span class="hljs-punctuation">:</span><span class="hljs-number">752</span>) at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java<span class="hljs-punctuation">:</span><span class="hljs-number">37</span>) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java<span class="hljs-punctuation">:</span><span class="hljs-number">1128</span>) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java<span class="hljs-punctuation">:</span><span class="hljs-number">628</span>) at java.lang.Thread.run(Thread.java<span class="hljs-punctuation">:</span><span class="hljs-number">829</span>)<br></code></pre></td></tr></table></figure>

<blockquote>
<p>核心错误日志</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">Caused by: CircuitBreakingException[[script] Too many dynamic script compilations within, max: [__PATH__]; please use indexed, or scripts with parameters instead; <span class="hljs-built_in">this</span> limit can be changed by the [script.context.number_sort.max_compilations_rate] setting]<br></code></pre></td></tr></table></figure>

<p>发现是ES出现了内存熔断——Script 编译熔断。由于在系统中有多个页面用到ES的检索，其中包含购物车推荐商品、推广详情页、商品详情推荐商品以及其他活动逻辑页配置的商品列表，而获取这些商品列表中有用到Script脚本去做复杂逻辑的脚本排序，而在ES中Script编译熔断的作用是<strong>限制一段时间内 Script 编译次数</strong>，而默认值是75&#x2F;5m( es第一次获取到script时会进行编译并缓存。Tips：使用 params 参数化脚本而不是写死到脚本中)，即5分钟编译75次，当超过75此后则抛出上面异常。</p>
<p>查询出这个问题后，立马修改了script.context.number_sort.max_compilations_rate的值，后发现异常堆栈信息消失，异常解决。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>此次异常的出现是对【ES内存以及熔断】不够了解，ES基于保护机制而设置了多种熔断机制，其中包含：</p>
<ul>
<li>Field data 熔断器</li>
<li>Request 熔断器</li>
<li>In flight requests 熔断器</li>
<li>Accounting requests 熔断器</li>
<li>Script 编译熔断器</li>
<li>Regex 熔断器</li>
</ul>
<p>详细可以查看：<a href="https://blog.csdn.net/qq_16164711/article/details/120709299">https://blog.csdn.net/qq_16164711/article/details/120709299</a></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Elastic Search</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/post/1f45aa00-901b-11ee-a594-b7c3b2bd0d34.html</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
</search>
